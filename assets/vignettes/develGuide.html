<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>R/qtlcharts Developer Guide</title>





<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}

pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<h1>R/qtlcharts Developer Guide</h1>

<p><a href="http://kbroman.github.io/qtlcharts">R/qtlcharts</a> is an
<a href="http://www.r-project.org">R</a> package to create interactive charts for
QTL data, for use with <a href="http://www.rqtl.org">R/qtl</a>.
R/qtlcharts is written in
<a href="http://www.r-project.org">R</a> and
<a href="http://coffeescript.org">CoffeeScript</a>, making use of the JavaScript
libraries <a href="http://d3js.org">D3</a> and
<a href="https://github.com/caged/d3-tip">d3-tip</a>, as well as
<a href="http://colorbrewer2.org">ColorBrewer</a>.</p>

<p>The aim of this guide is to explain the basic strategy of the package
and the organization of the code, in the hope that others may wish to
contribute to its development or to make use of different pieces of
the software.</p>

<h2>Basic layout of source</h2>

<p>The source for the package is at
<a href="http://github.com/kbroman/qtlcharts">GitHub</a>:
<a href="http://github.com/kbroman/qtlcharts"><code>http://github.com/kbroman/qtlcharts</code></a>.
The <a href="https://github.com/kbroman/qtlcharts/tree/devel"><code>devel</code> branch</a>
contains the current development version, but it is not far ahead (if
at all) from the
<a href="https://github.com/kbroman/qtlcharts/tree/master"><code>master</code> branch</a>.</p>

<p>JavaScript and CoffeeScript code are within the
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst"><code>inst/</code></a>
subdirectory. (When the package is <em>installed</em>, the contents of the
<code>inst</code> directory are moved up one level, and there is no <code>inst</code>
directory anymore.)</p>

<p>The three main libraries are in
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/d3"><code>inst/d3</code></a>,
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/d3-tip"><code>inst/d3-tip</code></a>
and
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/colorbrewer"><code>inst/colorbrewer</code></a>.</p>

<p>The interactive charts are built on a set of
<a href="http://kbroman.github.io/qtlcharts/pages/panels.html">reuseable D3-based graphic panels</a>,
contained in
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/panels"><code>inst/panels</code></a>.
These were designed following
<a href="http://bost.ocks.org/mike">Mike Bostock</a>&#39;s
<a href="http://bost.ocks.org/mike/chart/">Towards Reuseable Charts</a>.
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/panels/panelutil.coffee"><code>panelutil.coffee</code></a>
contains various utility functions used by one or more panels, and
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/panels/panelutil.css"><code>panelutil.css</code></a>
contains CSS code for the panels. The actual panels are in
subdirectories of
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/panels"><code>inst/panels</code></a>,
and each contains a <code>test</code> subdirectory with test code.</p>

<p>The higher-level charts are located in
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/charts"><code>inst/charts</code></a>.
This is where most of the interactivity is encoded: a chart basically
passes data to individual panels and sets up the interactions among
the panels.
<a href="https://github.com/kbroman/qtlcharts/blob/master/inst/charts/charts.css"><code>charts.css</code></a>
contains a bit of CSS code for the charts.</p>

<h2>CoffeeScript</h2>

<p>R/qtlcharts is being developed in
<a href="http://coffeescript.org">CoffeeScript</a> rather than JavaScript,
though the CoffeeScript code is translated to JavaScript and it is
the JavaScript that is ultimately used.</p>

<p>The CoffeeScript code is not that far from JavaScript: the bulk of the
code is basically not different. So why add this extra layer, with
CoffeeScript? CoffeeScript is a nicer language
and is more fun to code, and a number of things are easier or more
compact than JavaScript.</p>

<p>For example, <a href="http://d3js.org">D3</a> code generally includes a lot of anonymous
functions, like</p>

<pre><code>blah.attr(&quot;x&quot;, function(d) { return xscale(d); });
</code></pre>

<p>In CoffeeScript, this becomes</p>

<pre><code>blah.attr(&quot;x&quot;, (d) -&gt; xscale(d))
</code></pre>

<p>Also, in dealing with missing values, or with default values,
CoffeeScript has some features that make life easier. Here&#39;s an
example:</p>

<pre><code>height = chartOpts?.height ? 450
</code></pre>

<p>The JavaScript version of this is cumbersome and ugly.</p>

<h2>Basic strategy</h2>

<p>For each chart there is an R function that writes to an html file (by
default, a temporary file in a temporary directory, defined with
<a href="http://stat.ethz.ch/R-manual/R-devel/library/base/html/tempfile.html"><code>tempfile()</code></a>
and
<a href="http://stat.ethz.ch/R-manual/R-devel/library/base/html/tempfile.html"><code>tempdir()</code></a>),
which is then opened in a browser.</p>

<p>The data are simply pasted into the html file in
<a href="http://json.org">JSON</a> format. This may make the chart slow to load,
but it allows us to get around browser security settings which
generally disallow access to local files.</p>

<p>The basic functions for writing html are in
<a href="https://github.com/kbroman/qtlcharts/blob/master/R/write_html.R"><code>write_html.R</code></a>.
The R function <a href="http://stat.ethz.ch/R-manual/R-devel/library/base/html/system.file.html"><code>system.file</code></a> is used to define links to the JavaScript
and CSS code that are contained within the package. For example, the
location of the <code>d3.min.js</code> file is determined through</p>

<pre><code>system.file(&#39;d3&#39;, &#39;d3.min.js&#39;, package=&#39;qtlcharts&#39;)
</code></pre>

<p>We&#39;re generally using temporary files and writing links to the
JavaScript code, but if the argument <code>onefile=TRUE</code>, we paste the code
directly using the R function
<a href="http://stat.ethz.ch/R-manual/R-patched/library/base/html/files.html"><code>file.append</code></a>. (The
resulting file is then self-contained and so portable.)</p>

<p>For creating interactive charts within R Markdown documents (see
<a href="http://kbroman.github.io/qtlcharts/assets/vignettes/Rmarkdown.html">the related vignette</a>),
one would use <code>print=TRUE</code>, in which case rather than appending code
to a file, we&#39;d simply print it (with <code>cat(readLines(file), sep=&quot;\n&quot;)</code>).</p>

<p>Customization options for a chart are passed via an R argument
<code>chartOpts</code>, which is also written to the html file in JSON format and
passed as an argument to the relevant chart function. The chart itself
will be placed within a <code>&lt;div&gt;</code> with an ID specific to the chart (by
default, <code>chart</code>. The names of the data objects (including the
<code>chartOpts</code> object) are prepended with this same div ID. This is to
avoid conflicts among multiple charts, particularly within
<a href="http://kbroman.github.io/qtlcharts/assets/vignettes/Rmarkdown.html">R Markdown files</a>.</p>

<h2>Customization options</h2>

<p>For each chart, there are numerous possible customizations that one
may wish to apply. To simplify the maintenance of these options, the R
function for each chart takes an argument <code>chartOpts</code>, that is a named
list (in simple cases, a named vector will do). This is passed to the
corresponding CoffeeScript function for the chart, which looks for
specific named components. If a specific option (e.g., <code>height</code> or
<code>width</code>) is named, the option is used in place of the default.</p>

<p>The allowable options are maintained in one place: the CoffeeScript
code in which they are used. These need to be listed at the top of the
file in a format like the following (taken from
<a href="https://github.com/kbroman/qtlcharts/tree/master/inst/charts/iplotCorr.coffee"><code>iplotCorr.coffee</code></a>).</p>

<pre><code># chartOpts start
height = chartOpts?.height ? 450 # height of each panel in pixels
width = chartOpts?.width ? height # width of each panel in pixels
margin = chartOpts?.margin ? {left:70, top:40, right:5, bottom: 70, inner:5} # margins in pixels (left, top, right, bottom, inner)
corcolors = chartOpts?.corcolors ? [&quot;darkslateblue&quot;, &quot;white&quot;, &quot;crimson&quot;] # heat map colors (same length as `zlim`)
zlim = chartOpts?.zlim ? [-1, 0, 1] # z-axis limits
rectcolor = chartOpts?.rectcolor ? &quot;#E6E6E6&quot; # color of background rectangle
cortitle = chartOpts?.cortitle ? &quot;&quot; # title for heatmap panel
scattitle = chartOpts?.scattitle ? &quot;&quot; # title for scatterplot panel
scatcolors = chartOpts?.scatcolors ? null # vector of point colors for scatterplot
# chartOpts end
</code></pre>

<p>The name of the option used within the file (on the left) should match
that used within the R code (e.g., <code>height</code> and <code>chartOpts.height</code>),
and each line should end with a comment describing the option.
This is so that a ruby script
(<a href="https://github.com/kbroman/qtlcharts/blob/master/vignettes/chartOpts/grab_chartOpts.rb"><code>grab_chartOpts.rb</code></a>)
can parse all of these options and create the
<a href="http://kbroman.github.io/qtlcharts/assets/vignettes/chartOpts.html">chartOpts vignette</a>,
which provides a list of all possible options.</p>

<p>Some charts have multiple versions (e.g., <code>iplotScanone</code> with no
effects, with confidence intervals, or with raw phenotype &times;
genotype).  The file <a href="https://github.com/kbroman/qtlcharts/blob/master/vignettes/chartOpts/multiversions.csv"><code>multiversions.csv</code></a>
lists the chart name and a bit of Markdown code to describe the
version. Also, the order of the charts in the
<a href="http://kbroman.github.io/qtlcharts/assets/vignettes/chartOpts.html">chartOpts vignette</a>
is determined from the order in this file.</p>

<h2>R &rarr; JSON</h2>

<p>Data is pasted into the chart file as <a href="http://json.org">JSON</a>; they are converted from R
objects to JSON using the
<a href="https://github.com/jeroenooms/jsonlite">jsonlite</a> package.</p>

<p>There are some occasional annoyances, particularly in ensuring that
an object becomes a hash (i.e., associative array) or an array (i.e.,
vector or list), or that a single value becomes a scalar or an array
of length 1.</p>

<p>An additional difficulty with jsonlite concerns the number of digits that are
retained in the JSON object. jsonlite is currently using <code>round</code> (see
<a href="https://github.com/jeroenooms/jsonlite/blob/master/R/asJSON.numeric.R"><code>asJSON.numeric.R</code></a>),
though <code>formatC</code> would probably be better.
Most chart functions in R/qtlcharts take a <code>digits</code> argument which is
passed to the <code>toJSON</code> to control the number of digits retained in the
JSON objects. We want sufficient digits to keep things from looking
too discrete in the chart, but too many digits results in large files
and load times.</p>

<h2>Roxygen</h2>

<p>Using Roxygen to create R help files</p>

<h2>Licenses</h2>

<p>Licensed under the
<a href="LICENSE">MIT license</a>. (<a href="http://en.wikipedia.org/wiki/MIT_License">More information here</a>.)</p>

<p>R/qtlcharts incorporates <a href="http://d3js.org">D3.js</a>
(<a href="https://github.com/kbroman/qtlcharts/blob/master/inst/d3/LICENSE">see its license</a>),
<a href="http://github.com/Caged/d3-tip">d3.tip</a>
(<a href="https://github.com/kbroman/qtlcharts/blob/master/inst/d3-tip/LICENSE">see its license</a>),
and <a href="http://colorbrewer2.org">ColorBrewer</a>
(<a href="https://github.com/kbroman/qtlcharts/blob/master/inst/colorbrewer/LICENSE">see its license</a>).</p>

<!-- the following to make it look nicer -->

<p><link href="http://kbroman.github.io/qtlcharts/assets/vignettes/vignette.css" rel="stylesheet"></link></p>

</body>

</html>
